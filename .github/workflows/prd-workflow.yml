name: CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  WORKING_DIRECTORY: /home/worker/workspace/agiliza-previ/cnis-analyser-pro
  ACTION_ENV: prd

jobs:
  build:
    runs-on: production
    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ³ Build Docker Image
        run: |
          docker build --memory="2g" --no-cache -t ${{ vars.REGISTRY_URL }} .

      - name: âš™ï¸ Update Container Environment Variables
        run: |
          mv .env.${{ env.ACTION_ENV }} .env

  deploy:
    needs: build
    runs-on: production
    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Extract App Version
        run: echo "APP_VERSION=$(jq -r .version package.json)" >> $GITHUB_ENV

      - name: âš™ï¸ Update Container Environment Variables
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          echo -e '${{ vars.PRD_ENVS }}' > ${{ env.WORKING_DIRECTORY }}/.container.env

      - name: ðŸ›‘ Stop Old Docker Container
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          bash ${{ env.WORKING_DIRECTORY }}/remove.container.sh || true

      - name: ðŸš€ Start New Docker Container
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          bash ${{ env.WORKING_DIRECTORY }}/start.container.sh
